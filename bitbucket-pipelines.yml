image: atlassian/default-image:4

pipelines:
  branches:
    main:
      - step:
          name: Build, Tag, Push, and Deploy
          services:
            - docker
          caches:
            - docker
          script:
            - echo "ðŸ”§ Installing dependencies"
            - apt-get update && apt-get install -y python3-pip curl unzip jq
            - pip3 install --upgrade awscli

            - echo "ðŸ”§ Setting tagging variables"
            - export DATE_TIME_TAG=$(date +%d%m%y-%H%M)
            - export SHORT_SHA=$(git rev-parse --short HEAD)
            - export TAG="build-$DATE_TIME_TAG-$SHORT_SHA"
            - export ECR_REPO="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME"

            - echo "ðŸ” Logging into Amazon ECR"
            - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO

            - echo "ðŸ“¥ Pulling .env config from SSM Parameter Store"
            - export PARAM_NAME="/php-todo/$BITBUCKET_BRANCH/env"
            - aws ssm get-parameter --name "$PARAM_NAME" --region $AWS_REGION --with-decryption --query "Parameter.Value" --output text > .env

            - echo "ðŸ“„ Injected .env content:"
            - cat .env

            - echo "âœ… Deployment completed successfully!"
