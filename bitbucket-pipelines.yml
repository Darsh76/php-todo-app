image: atlassian/default-image:4

pipelines:
  branches:
    main:
      - step:
          name: Build, Tag, Push, and Deploy
          services:
            - docker
          caches:
            - docker
          script:
            - echo "üîß Installing AWS CLI (required for ECR/ECS)"
            - apt-get update && apt-get install -y python3-pip curl unzip
            - pip3 install --upgrade awscli
            - aws --version

            - echo "üîß Setting up variables"
            - export DATE_TAG=$(date +%d%m%y)
            - export ECR_REPO="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME"
            - export LOCAL_TAG="$IMAGE_NAME:$DATE_TAG"

            - echo "üîê Logging into AWS ECR"
            - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO

            - echo "üê≥ Building Docker image"
            - docker build -t $LOCAL_TAG .

            - echo "üè∑ Tagging image as :latest and :$DATE_TAG"
            - docker tag $LOCAL_TAG $ECR_REPO:latest
            - docker tag $LOCAL_TAG $ECR_REPO:$DATE_TAG

            - echo "üì¶ Pushing images to ECR"
            - docker push $ECR_REPO:latest
            - docker push $ECR_REPO:$DATE_TAG

            - echo "üöÄ Updating ECS service"
            - aws ecs update-service --cluster php-todo-cluster --service php-todo-service --force-new-deployment --region $AWS_REGION


            - echo "‚úÖ Pipeline completed successfully!"
